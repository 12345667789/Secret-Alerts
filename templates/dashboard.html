<!DOCTYPE html>
<html lang="en">
<head>
    <title>Secret_Alerts Intelligence Dashboard</title>
    <style>
        /* NEW: CSS variables for theming */
        :root {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --header-color: #00d9ff;
            --border-color: #333;
            --button-bg: #0099ff;
            --button-hover: #0077cc;
            --table-header-bg: #2a2a2a;
            --log-box-bg: #0a0e27;
        }

        [data-theme="light"] {
            --bg-color: #f4f7f6;
            --card-bg-color: #ffffff;
            --text-color: #1a202c;
            --header-color: #0077cc;
            --border-color: #e2e8f0;
            --button-bg: #4a90e2;
            --button-hover: #357ABD;
            --table-header-bg: #f8fafc;
            --log-box-bg: #e2e8f0;
        }
        
        /* Styles updated to use CSS variables */
        body { background: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 2rem; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { color: var(--header-color); }
        .card { background: var(--card-bg-color); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        h2 { color: var(--header-color); border-bottom: 2px solid var(--header-color); padding-bottom: 10px; }
        .trust-header h2 { color: #4CAF50; border-bottom: 2px solid #4CAF50;}
        .intelligence-header h2 { color: #FFD700; border-bottom: 2px solid #FFD700;}
        .batching-header h2 { color: #FF6B35; border-bottom: 2px solid #FF6B35;}
        .log-box { height: 300px; overflow-y: auto; background: var(--log-box-bg); padding: 1rem; border-radius: 8px; font-family: monospace; }
        .btn { background: var(--button-bg); color: #fff; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 0.25rem; border: none; cursor: pointer; }
        .btn:hover { background: var(--button-hover); }
        .time-travel-btn { background: #9c27b0; }
        .time-travel-btn:hover { background: #7b1fa2; }
        .intelligence-btn { background: #FFD700; color: #000; }
        .intelligence-btn:hover { background: #FFC107; }
        .batching-btn { background: #FF6B35; }
        .batching-btn:hover { background: #E55A2B; }
        input[type="password"] { background: #0a0e27; border: 1px solid #00d9ff; color: #fff; padding: 0.5rem; border-radius: 4px; }
        .success { color: #28a745; }
        .warning { color: #fca311; }
        .error { color: #e63946; }
        .trust-container { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-top: 2rem; }
        .data-freshness { grid-column: 1 / 4; }
        .batching-status { grid-column: 4 / 7; }
        .transaction-log { grid-column: 7 / -1; }
        .intelligence-summary { grid-column: 1 / 7; }
        .alert-ledger { grid-column: 1 / -1; margin-top: 1.5rem; }
        .status-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: center; }
        .status-grid strong { color: #aaa; }
        .status-value { font-family: 'Courier New', monospace; font-size: 1.1em; word-wrap: break-word; }
        .status-good { color: #66bb6a; }
        .status-bad { color: #ef5350; }
        .status-vip { color: #FFD700; }
        .status-batching { color: #FF6B35; }
        .log-table, .ledger-table { width: 100%; border-collapse: collapse; font-family: 'Courier New', monospace; }
        .log-table th, .log-table td, .ledger-table th, .ledger-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .log-table th, .ledger-table th { background-color: var(--table-header-bg); }
        .log-level-SUCCESS { color: #66bb6a; }
        .log-level-ERROR { color: #ef5350; }
        .log-level-WARN { color: #ffa726; }
        .log-level-INFO { color: #42a5f5; }
        .table-container { max-height: 400px; overflow-y: auto; }
        .controls-form { display: inline-flex; align-items: center; gap: 10px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>üöÄ Secret_Alerts Intelligence Dashboard</h1></div>
        
        <div class="card">
            <h2>System Controls</h2>
            <button id="theme-toggle" class="btn">üåó Toggle Theme</button>
            <hr style="border-color: #333; margin: 1rem 0;">
            
            <form action="/report-open-alerts" method="post" class="controls-form">
                <input type="password" name="password" required placeholder="Password">
                <button type="submit" class="btn">üìä Report All Open Alerts</button>
            </form>
            
            <form action="/reset-monitor-state" method="post" class="controls-form" onsubmit="return confirm('Are you sure you want to reset the monitor state?');">
                <input type="password" name="password" required placeholder="Password">
                <button type="submit" class="btn" style="background-color: #f44336;">üîÑ Reset Monitor State</button>
            </form>
            
            <hr style="border-color: #333; margin: 1rem 0;">

            <a href="/time-travel" class="btn time-travel-btn">üïê Time Travel Test</a>
            <a href="/test-intelligence" class="btn intelligence-btn">üß† Test Intelligence</a>
            <a href="/test-batching" class="btn batching-btn">üÉè Test Batching</a>
        </div>

        <div class="trust-container">
            <div class="card data-freshness trust-header">
                <h2>üõ°Ô∏è 1. Data Freshness</h2>
                <div id="freshness-content">Loading...</div>
            </div>
            <div class="card batching-status batching-header">
                <h2>üÉè 2. Smart Batching</h2>
                <div id="batching-content">
                    <div class="status-grid">
                        <strong>Status:</strong><span class="status-value status-batching">Active</span>
                        <strong>Mode:</strong><span class="status-value" id="batch-mode">Loading...</span>
                        <strong>Window:</strong><span class="status-value" id="batch-window">Loading...</span>
                        <strong>Purpose:</strong><span class="status-value">Double Mint Detection</span>
                    </div>
                </div>
            </div>
            <div class="card transaction-log trust-header">
                <h2>üõ°Ô∏è 3. Recent Activity Log</h2>
                <div class="table-container">
                    <table class="log-table">
                        <thead><tr><th>Time</th><th>Level</th><th>Message</th></tr></thead>
                        <tbody id="log-content"><tr><td colspan="3">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="card intelligence-summary intelligence-header">
                <h2>üß† 4. Intelligence Summary</h2>
                <div id="intelligence-content">Loading...</div>
            </div>
            <div class="card alert-ledger trust-header">
                <h2>üõ°Ô∏è 5. Alert Ledger (Confirmed Sent)</h2>
                <div class="table-container">
                    <table class="ledger-table">
                        <thead><tr><th>Alert ID</th><th>Time</th><th>Type</th><th>Symbol</th><th>Priority</th><th>Freq</th><th>üÉè</th><th>Details</th></tr></thead>
                        <tbody id="ledger-content"><tr><td colspan="8">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Legacy Log Viewer</h2>
            <div class="log-box">{{ logs_html|safe }}</div>
        </div>
    </div>

    <script>
        // NEW: JavaScript for theme switching
        const themeToggle = document.getElementById('theme-toggle');
        const htmlEl = document.documentElement;

        // Function to set the theme
        const setTheme = (theme) => {
            htmlEl.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };

        // Apply saved theme on page load
        const currentTheme = localStorage.getItem('theme') || 'dark';
        setTheme(currentTheme);

        // Event listener for the toggle button
        themeToggle.addEventListener('click', () => {
            const newTheme = htmlEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // Your existing script content remains the same...
        function updateBatchingStatus() {
            const now = new Date();
            const cst = new Date(now.toLocaleString("en-US", {timeZone: "America/Chicago"}));
            const currentTime = cst.getHours() * 100 + cst.getMinutes();
            let mode, window_seconds;
            if (currentTime >= 800 && currentTime < 920) { mode = "PRE-MARKET"; window_seconds = 30; } 
            else if (currentTime >= 920 && currentTime <= 1000) { mode = "RUSH HOUR"; window_seconds = 90; } 
            else if (currentTime >= 930 && currentTime <= 1600) { mode = "MARKET HOURS"; window_seconds = 45; } 
            else { mode = "AFTER HOURS"; window_seconds = 15; }
            document.getElementById('batch-mode').textContent = mode;
            document.getElementById('batch-window').textContent = window_seconds + "s";
        }
        
        function updateDashboard() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    const freshnessDiv = document.getElementById('freshness-content');
                    const lastCheck = data.last_check;
                    const successClass = lastCheck.successful ? 'status-good' : 'status-bad';
                    const successText = lastCheck.successful ? 'Success' : 'Failed';
                    freshnessDiv.innerHTML = `<div class="status-grid"><strong>Last Check:</strong><span class="status-value">${lastCheck.timestamp||'N/A'}</span><strong>Status:</strong><span class="status-value ${successClass}">${successText}</span><strong>File Hash:</strong><span class="status-value">${lastCheck.file_hash}</span><strong>Details:</strong><span class="status-value">${lastCheck.error_message||'OK'}</span></div>`;
                    const logBody = document.getElementById('log-content');
                    logBody.innerHTML = '';
                    if (data.transactions.length === 0) { logBody.innerHTML = '<tr><td colspan="3">No transactions logged yet.</td></tr>'; } 
                    else { data.transactions.forEach(log => { const row = logBody.insertRow(); row.innerHTML = `<td>${log.timestamp}</td><td class="log-level-${log.level}">${log.level}</td><td>${log.message}</td>`; }); }
                    const ledgerBody = document.getElementById('ledger-content');
                    ledgerBody.innerHTML = '';
                    if (data.alerts.length === 0) { ledgerBody.innerHTML = '<tr><td colspan="8">No alerts sent yet.</td></tr>'; } 
                    else { data.alerts.forEach(alert => { const row = ledgerBody.insertRow(); const priorityEmoji = alert.priority === 'VIP' ? 'üíé' : alert.priority === 'HIGH' ? 'üî•' : 'üîµ'; const doubleMintIcon = alert.double_mint ? 'üÉè' : ''; row.innerHTML = `<td>${alert.alert_id}</td><td>${alert.timestamp}</td><td>${alert.alert_type}</td><td>${alert.symbol}</td><td>${priorityEmoji}</td><td>${alert.frequency||1}x</td><td>${doubleMintIcon}</td><td>${alert.details}</td>`; }); }
                })
                .catch(error => console.error('Failed to update dashboard:', error));

            fetch('/api/intelligence')
                .then(response => response.json())
                .then(intData => {
                    const intelDiv = document.getElementById('intelligence-content');
                    if (intData.stats && Object.keys(intData.stats).length > 0) {
                        intelDiv.innerHTML = `<div class="status-grid"><strong>Total Alerts:</strong><span class="status-value">${intData.stats.total_alerts}</span><strong>VIP Alerts:</strong><span class="status-value status-vip">üíé ${intData.stats.vip_alerts}</span><strong>Double Mint:</strong><span class="status-value">üÉè ${intData.stats.double_mint_alerts}</span><strong>High Frequency:</strong><span class="status-value">üî• ${intData.stats.high_frequency_alerts}</span><strong>Avg Frequency:</strong><span class="status-value">${intData.stats.average_frequency}x</span><strong>Status:</strong><span class="status-value status-good">${intData.message}</span></div>`;
                    } else { intelDiv.innerHTML = '<p>Intelligence system initializing...</p>'; }
                })
                .catch(error => { console.error('Failed to update intelligence:', error); document.getElementById('intelligence-content').innerHTML = '<p>Intelligence data unavailable</p>'; });
            
            updateBatchingStatus();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            setInterval(updateDashboard, 15000);
        });
    </script>
</body>
</html>